# MPL Playground — Stage 4L Patch (Session Presets + Quick‑Switch Profiles + Keyboard Palette)

This patch layers **ergonomics & speed** on top of 4C–4K:

* **Session Presets**: one‑click bundles of renderer/physics/LOD/view options (built‑ins + user‑defined, persisted)
* **Quick‑Switch Profiles**: assign up to 5 presets to number keys **1–5** (hold **Shift** to assign)
* **Keyboard Palette**: `Ctrl/⌘ + K` opens a command palette with fuzzy search across actions, toggles, and presets

No external deps.

---

## Highlights

* Three curated built‑ins: **Performance (10k+)**, **Analysis**, **Publication**
* User presets: save/load/rename/delete; stored in `localStorage` (`mpl.presets.v1`)
* Palette searches across **commands** (e.g., *Fit selection*, *Toggle bundling*), **modes** (edge routing, layout), and **presets**
* Quick switch shows inline pill badges for assigned slots, supports **Shift+<1..5>** to bind current view

---

## 1) `engine/ui/presets.ts` (new) — preset model & built‑ins

```ts
// engine/ui/presets.ts
export type Preset = {
  id: string; name: string; builtIn?: boolean;
  view: {
    layout: { useWorker: boolean; mode: 'grid'|'barnes'|'naive' };
    physics: { strength: number };
    bundling: { on: boolean; strength: number };
    cluster: { colorBy: boolean; hulls: boolean };
    lod: { edgeBudget: number; labelMinZoom: number; sampleStride: number };
    render: { edgeMode: 'straight'|'arc'|'quad'; curvA: number; curvB: number };
  };
};

export const BuiltIns: Preset[] = [
  {
    id: 'perf', name: 'Performance (10k+)', builtIn: true,
    view: {
      layout: { useWorker: true, mode: 'barnes' },
      physics: { strength: 0.9 },
      bundling: { on: true, strength: 0.45 },
      cluster: { colorBy: false, hulls: false },
      lod: { edgeBudget: 1200, labelMinZoom: 0.95, sampleStride: 4 },
      render: { edgeMode: 'straight', curvA: 0.06, curvB: 0.12 },
    }
  },
  {
    id: 'analysis', name: 'Analysis', builtIn: true,
    view: {
      layout: { useWorker: true, mode: 'barnes' },
      physics: { strength: 1.0 },
      bundling: { on: true, strength: 0.6 },
      cluster: { colorBy: true, hulls: false },
      lod: { edgeBudget: 2200, labelMinZoom: 0.7, sampleStride: 2 },
      render: { edgeMode: 'arc', curvA: 0.10, curvB: 0.24 },
    }
  },
  {
    id: 'pub', name: 'Publication', builtIn: true,
    view: {
      layout: { useWorker: false, mode: 'grid' },
      physics: { strength: 0.7 },
      bundling: { on: true, strength: 0.75 },
      cluster: { colorBy: true, hulls: true },
      lod: { edgeBudget: 4000, labelMinZoom: 0.5, sampleStride: 1 },
      render: { edgeMode: 'quad', curvA: 0.14, curvB: 0.3 },
    }
  },
];

const KEY = 'mpl.presets.v1';

export function loadUserPresets(): Preset[] {
  try { const raw = localStorage.getItem(KEY); return raw ? JSON.parse(raw) : []; } catch { return []; }
}
export function saveUserPresets(presets: Preset[]){ try { localStorage.setItem(KEY, JSON.stringify(presets)); } catch {} }

export function allPresets(): Preset[] { return [...BuiltIns, ...loadUserPresets()]; }

export function createFromView(name: string, view: Preset['view']): Preset {
  return { id: Math.random().toString(36).slice(2,8), name, view };
}
```

---

## 2) `engine/ui/quickSwitch.ts` (new) — 1–5 slots

```ts
// engine/ui/quickSwitch.ts
import type { Preset } from './presets';

const KEY = 'mpl.quickslots.v1';
export type QuickSlots = (string|null)[]; // length 5, preset ids or null

export function loadSlots(): QuickSlots { try { const raw = localStorage.getItem(KEY); return raw ? JSON.parse(raw) : [null,null,null,null,null]; } catch { return [null,null,null,null,null]; } }
export function saveSlots(s: QuickSlots){ try { localStorage.setItem(KEY, JSON.stringify(s)); } catch {} }

export function assignSlot(idx: number, presetId: string){ const s=loadSlots(); s[idx]=presetId; saveSlots(s); }
```

---

## 3) `playground/components/PresetPanel.tsx` (new) — manage & apply presets

```tsx
// playground/components/PresetPanel.tsx
import React from 'react';
import type { Preset } from '../../engine/ui/presets';
import { allPresets, createFromView, loadUserPresets, saveUserPresets } from '../../engine/ui/presets';
import { assignSlot, loadSlots } from '../../engine/ui/quickSwitch';

export const PresetPanel: React.FC<{
  current: Preset['view'];
  onApply: (v: Preset['view']) => void;
}>
= ({ current, onApply }) => {
  const [presets, setPresets] = React.useState<Preset[]>(allPresets());
  const [slots, setSlots] = React.useState(loadSlots());
  const [name, setName] = React.useState('My Preset');

  function refresh(){ setPresets(allPresets()); setSlots(loadSlots()); }

  function save(){ const p = createFromView(name, current); const user = [...loadUserPresets(), p]; saveUserPresets(user); refresh(); }
  function del(id:string){ const user = loadUserPresets().filter(p=>p.id!==id); saveUserPresets(user); refresh(); }

  return (
    <div className="mpl-card">
      <div className="mpl-card-h">Presets</div>
      <div className="mpl-card-b" style={{ display:'grid', gap:10 }}>
        <div className="mpl-row">
          <input value={name} onChange={e=>setName(e.target.value)} style={{ flex:1, padding:6, border:'1px solid #e5e7eb', borderRadius:8 }} />
          <button className="mpl-btn" onClick={save}>Save Current</button>
        </div>
        <div className="mpl-presets">
          {presets.map(p => (
            <div key={p.id} className="mpl-preset">
              <div className="mpl-preset-h"><strong>{p.name}</strong>{p.builtIn ? <span className="mpl-chip" style={{ background:'#eef2ff' }}>built‑in</span> : null}</div>
              <div className="mpl-row">
                <button className="mpl-btn" onClick={()=>onApply(p.view)}>Apply</button>
                {!p.builtIn && <button className="mpl-btn" onClick={()=>del(p.id)}>Delete</button>}
                <div className="mpl-row" style={{ marginLeft:'auto' }}>
                  {[0,1,2,3,4].map(i => <button key={i} className="mpl-btn" title={`Assign to ${i+1}`} onClick={()=>{ assignSlot(i,p.id); setSlots(loadSlots()); }}>Slot {i+1}{slots[i]===p.id? ' ✓':''}</button>)}
                </div>
              </div>
            </div>
          ))}
        </div>
        <div className="mpl-dim">Tip: Press <kbd>Shift</kbd>+<kbd>1..5</kbd> to assign the current preset; press <kbd>1..5</kbd> to apply.</div>
      </div>
    </div>
  );
};
```

---

## 4) `playground/components/QuickSwitch.tsx` (new) — pill bar & hotkeys

```tsx
// playground/components/QuickSwitch.tsx
import React from 'react';
import { allPresets } from '../../engine/ui/presets';
import { loadSlots, assignSlot } from '../../engine/ui/quickSwitch';

export const QuickSwitch: React.FC<{ onApply: (view:any)=>void; currentViewId?: string|null }>
= ({ onApply, currentViewId=null }) => {
  const [slots, setSlots] = React.useState(loadSlots());
  const [presetsById, setPresetsById] = React.useState(() => Object.fromEntries(allPresets().map(p=>[p.id,p])));

  React.useEffect(() => { const onKey = (e: KeyboardEvent) => {
    const i = parseInt(e.key, 10); if (!i || i<1 || i>5) return;
    const idx = i-1; const s = loadSlots(); const pid = s[idx];
    if (e.shiftKey){ if (currentViewId) { assignSlot(idx, currentViewId); setSlots(loadSlots()); } }
    else if (pid && presetsById[pid]){ onApply(presetsById[pid].view); }
  }; window.addEventListener('keydown', onKey); return () => window.removeEventListener('keydown', onKey); }, [currentViewId, presetsById]);

  React.useEffect(() => { const t = setInterval(()=>{ setPresetsById(Object.fromEntries(allPresets().map(p=>[p.id,p]))); setSlots(loadSlots()); }, 800); return () => clearInterval(t); }, []);

  return (
    <div className="mpl-quick">
      {[0,1,2,3,4].map(i => {
        const pid = slots[i]; const label = pid && presetsById[pid] ? presetsById[pid].name : '—';
        return <span key={i} className={`mpl-pill ${pid?'on':''}`} title={`Press ${i+1} to apply; Shift+${i+1} to assign`}>{i+1}: {label}</span>;
      })}
    </div>
  );
};
```

---

## 5) `engine/ui/palette.tsx` (new) — keyboard command palette

```tsx
// engine/ui/palette.tsx
import React from 'react';
import { allPresets } from './presets';

export type PaletteItem = { id: string; label: string; hint?: string; run: () => void };

function score(q:string, s:string){ // tiny fuzzy: chars in order
  q=q.toLowerCase(); s=s.toLowerCase(); let qi=0; let sc=0; for (let i=0;i<s.length && qi<q.length;i++){ if (s[i]===q[qi]){ sc+=2; qi++; } else if (q.includes(s[i])) sc+=0.5; } return qi===q.length? sc : 0; }

export const CommandPalette: React.FC<{ items: PaletteItem[] }>
= ({ items }) => {
  const [open, setOpen] = React.useState(false);
  const [q, setQ] = React.useState('');

  React.useEffect(() => { const onKey = (e: KeyboardEvent) => { const mod = e.ctrlKey||e.metaKey; if (mod && e.key.toLowerCase()==='k'){ e.preventDefault(); setOpen(o=>!o); setQ(''); } if (e.key==='Escape') setOpen(false); }; window.addEventListener('keydown', onKey); return () => window.removeEventListener('keydown', onKey); }, []);

  const results = React.useMemo(() => { if (!q) return items.slice(0, 25); return items.map(it => ({ it, s: score(q, it.label + ' ' + (it.hint||'')) })).filter(x=>x.s>0).sort((a,b)=>b.s-a.s).slice(0,25).map(x=>x.it); }, [q, items]);

  if (!open) return null;
  return (
    <div className="mpl-palette" onClick={()=>setOpen(false)}>
      <div className="mpl-palette-box" onClick={e=>e.stopPropagation()}>
        <input autoFocus placeholder="Type a command or preset… (Esc to close)" value={q} onChange={e=>setQ(e.target.value)} />
        <div className="mpl-palette-list">
          {results.map((r,i) => <button key={i} className="mpl-palette-item" onClick={()=>{ r.run(); setOpen(false); }}>{r.label}{r.hint? <span>{r.hint}</span> : null}</button>)}
          {!results.length && <div className="mpl-palette-empty">No matches</div>}
        </div>
      </div>
    </div>
  );
};
```

---

## 6) Wiring commands from CanvasPanel

```tsx
// playground/components/CanvasPanel.tsx — 4L wiring (excerpt)
import React from 'react';
import type { ExecutionSnapshot } from '../../engine/debugger/graphTypes';
import { ensurePositions } from '../../engine/renderer/layout/seededLayout';
import { toSlim } from '../../engine/core/perf/timelineDelta';
import { GraphCanvas } from './GraphCanvas';
import { PresetPanel } from './PresetPanel';
import { QuickSwitch } from './QuickSwitch';
import { CommandPalette } from '../../engine/ui/palette';
import { BuiltIns, createFromView } from '../../engine/ui/presets';

export const CanvasPanel: React.FC<{ timeline: ExecutionSnapshot[]; index: number; onIndex?: (i:number)=>void }>
= ({ timeline, index, onIndex }) => {
  const slim = React.useMemo(() => ensurePositions(toSlim(timeline[Math.max(0, Math.min(index, timeline.length-1))] || { tick: index, monads: [], rulesFired: [] } as any)), [index, timeline]);

  // shared view state pulled from prior stages
  const [camera, setCamera] = React.useState({ x:0, y:0, z:1 });
  const [useWorker, setUseWorker] = React.useState(true);
  const [layoutMode, setLayoutMode] = React.useState<'grid'|'barnes'|'naive'>('barnes');
  const [phys, setPhys] = React.useState(1.0);
  const [bundling, setBundling] = React.useState({ on:true, strength:0.6 });
  const [cluster, setCluster] = React.useState({ colorBy:true, hulls:false });
  const [lod, setLOD] = React.useState({ edgeBudget: 2200, labelMinZoom: 0.7, sampleStride: 2 });
  const [render, setRender] = React.useState({ edgeMode: 'arc' as 'straight'|'arc'|'quad', curvA: 0.10, curvB: 0.24 });

  const graphRef = React.useRef<any>(null);

  // helpers to apply a preset view
  function applyView(v: any){ setUseWorker(v.layout.useWorker); setLayoutMode(v.layout.mode); setPhys(v.physics.strength); setBundling(v.bundling); setCluster(v.cluster); setLOD(v.lod); setRender(v.render); }

  // build palette items
  const items = React.useMemo(() => {
    const arr: any[] = [];
    // presets
    for (const p of BuiltIns){ arr.push({ id: 'preset:'+p.id, label: `Preset: ${p.name}`, hint: 'enter', run: () => applyView(p.view) }); }
    // commands & toggles
    arr.push({ id:'fit', label:'Fit to selection', run: () => (graphRef.current?._graph?.fitSelection?.() : null) });
    arr.push({ id:'toggle-bundle', label: bundling.on ? 'Disable bundling' : 'Enable bundling', run: () => setBundling(b => ({ ...b, on: !b.on })) });
    arr.push({ id:'toggle-cluster', label: cluster.colorBy ? 'Disable cluster colors' : 'Enable cluster colors', run: () => setCluster(c => ({ ...c, colorBy: !c.colorBy })) });
    arr.push({ id:'toggle-hulls', label: cluster.hulls ? 'Hide cluster hulls' : 'Show cluster hulls', run: () => setCluster(c => ({ ...c, hulls: !c.hulls })) });
    arr.push({ id:'edge-straight', label:'Edges: straight', run: () => setRender(r=>({ ...r, edgeMode:'straight' })) });
    arr.push({ id:'edge-arc', label:'Edges: arc', run: () => setRender(r=>({ ...r, edgeMode:'arc' })) });
    arr.push({ id:'edge-quad', label:'Edges: quad', run: () => setRender(r=>({ ...r, edgeMode:'quad' })) });
    arr.push({ id:'layout-grid', label:'Layout: grid', run: () => setLayoutMode('grid') });
    arr.push({ id:'layout-barnes', label:'Layout: barnes', run: () => setLayoutMode('barnes') });
    arr.push({ id:'layout-naive', label:'Layout: naive', run: () => setLayoutMode('naive') });
    arr.push({ id:'toggle-worker', label: useWorker ? 'Main‑thread physics' : 'Worker physics', run: () => setUseWorker(v=>!v) });
    // speed nudges
    arr.push({ id:'phys-plus', label:'Physics strength +', run: () => setPhys(p=>Math.min(2, +(p+0.1).toFixed(2))) });
    arr.push({ id:'phys-minus', label:'Physics strength −', run: () => setPhys(p=>Math.max(0.1, +(p-0.1).toFixed(2))) });
    return arr;
  }, [bundling.on, cluster.colorBy, cluster.hulls, render.edgeMode, useWorker]);

  // QuickSwitch current-view surrogate id (unsaved): derive ephemeral preset to enable Shift+1..5 assign
  const currentViewId = React.useMemo(() => {
    const v = { layout:{ useWorker, mode: layoutMode }, physics:{ strength: phys }, bundling, cluster, lod, render };
    // ephemeral: ensure a temporary preset exists so quick‑assign works if user holds Shift+1..5
    // Not persisted here — users should save via PresetPanel if they want it permanent.
    return createFromView('Current', v).id;
  }, [useWorker, layoutMode, phys, bundling.on, bundling.strength, cluster.colorBy, cluster.hulls, lod.edgeBudget, lod.labelMinZoom, lod.sampleStride, render.edgeMode, render.curvA, render.curvB]);

  return (
    <div className="mpl-grid">
      <div className="mpl-main">
        <QuickSwitch onApply={applyView} currentViewId={currentViewId} />
        {/* existing timeline heat + scrubber here */}
        <GraphCanvas ref={graphRef} snapshot={slim} camera={camera} onCamera={setCamera}
          useWorker={useWorker} layoutMode={layoutMode} physicsStrength={phys}
          blendT={1} style={{}} prevStyle={{}} edgeMode={render.edgeMode as any} curvA={render.curvA} curvB={render.curvB}
        />
        <div className="mpl-row">
          <PresetPanel current={{ layout:{ useWorker, mode: layoutMode }, physics:{ strength: phys }, bundling, cluster, lod, render }} onApply={applyView} />
        </div>
      </div>
      <aside className="mpl-side">
        <CommandPalette items={items} />
      </aside>
    </div>
  );
};
```

---

## 7) `playground/styles/debugger.css` (additions)

```css
/* Stage 4L — quick switch & palette */
.mpl-quick { display: flex; gap: 6px; margin-bottom: 6px; flex-wrap: wrap; }
.mpl-pill { font-size: 12px; padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 999px; background: #fff; }
.mpl-pill.on { background: #eef2ff; border-color: #c7d2fe; }

.mpl-presets { display: grid; gap: 10px; }
.mpl-preset { border: 1px solid #eef2f7; border-radius: 10px; padding: 8px; background: #fff; }
.mpl-preset-h { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }

.mpl-palette { position: fixed; inset: 0; background: rgba(0,0,0,.2); display: grid; place-items: start center; padding-top: 12vh; z-index: 50; }
.mpl-palette-box { width: min(720px, 90vw); background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.08); overflow: hidden; }
.mpl-palette-box > input { width: 100%; padding: 12px 14px; border: 0; border-bottom: 1px solid #eef2f7; font-size: 14px; outline: none; }
.mpl-palette-list { max-height: 52vh; overflow: auto; display: grid; }
.mpl-palette-item { text-align: left; padding: 10px 14px; border: 0; background: #fff; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; }
.mpl-palette-item:hover { background: #f8fafc; }
.mpl-palette-empty { padding: 18px; color: #6b7280; }
```

---

## 8) Example — `playground/pages/DebugExample4L.tsx`

```tsx
// playground/pages/DebugExample4L.tsx
import React, { useMemo } from "react";
import { DebuggerPanel } from "../components/DebuggerPanel";
import { ExecutionSnapshot } from "../../engine/debugger/graphTypes";

function demoHistory(): ExecutionSnapshot[] {
  const ids = Array.from({length: 200}, (_,i)=>String(i));
  const monads = ids.map((id,i)=>({ id, neighbors: [] as string[], x: Math.cos(i*.2)*260 + (Math.random()-0.5)*8, y: Math.sin(i*.2)*260 + (Math.random()-0.5)*8 }));
  for (let i=0;i<ids.length;i++) for (let j=i+1;j<ids.length;j++) if (Math.random()<0.02){ monads[i].neighbors.push(String(j)); monads[j].neighbors.push(String(i)); }
  return [{ tick:0, monads, rulesFired: ['Seed'] } as any];
}

export default function DebugExample4L(){
  const history = useMemo(demoHistory, []);
  return (
    <div style={{ padding: 24 }}>
      <h1>Stage 4L — Session Presets + Quick‑Switch Profiles + Keyboard Palette</h1>
      <DebuggerPanel history={history} />
      <p className="mpl-dim">Try: <kbd>Ctrl/⌘</kbd>+<kbd>K</kbd> for the palette • <kbd>1..5</kbd> to apply quick slots • <kbd>Shift</kbd>+<kbd>1..5</kbd> to assign.</p>
    </div>
  );
}
```

---

## 9) Notes

* **Safety**: Palette keybindings avoid blocking the browser’s native `Cmd+L`/`Cmd+T` combos; we only intercept `Cmd/Ctrl+K`.
* **Persistence**: Presets and quick slots are stored separately; built‑ins are always present.
* **Extensibility**: Add more palette items for your specialized tools (e.g., *Trace path A→B*, *Toggle isolate rule*, *Start capture*).
* **Performance**: The fuzzy matcher is intentionally tiny; swap for a more sophisticated scorer if you notice many ties.

---

## 10) Changelog — Stage 4L

* New: `engine/ui/presets.ts`, `engine/ui/quickSwitch.ts`, `engine/ui/palette.tsx`
* New UI: `PresetPanel.tsx`, `QuickSwitch.tsx`
* Updated: `CanvasPanel.tsx` (wiring for presets/quick‑switch/palette)
* Styles: new palette and pill bar

```
```
